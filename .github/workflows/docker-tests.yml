name: Docker API Tests

on:
  push:
    branches: [add-codeception-api-tests]

  workflow_dispatch:

jobs:
  test-api-dockerized:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get -y update
          sudo apt-get -y install curl 
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: "add-codeception-api-tests"
          submodules: "recursive"
      - name: Install PHP dependencies
        uses: php-actions/composer@v6
        with:
          php_version: 7.2
          version: 2
          php_extensions: pcntl curl
          args: --working-dir=app/
      - name: Checkout coolacid/docker-misp
        uses: actions/checkout@v2
        with:
          repository: coolacid/docker-misp
          path: docker-misp
      - name: Start MISP docker containers
        run: docker-compose -f /home/runner/work/MISP/MISP/docker-misp/docker-compose.yml -f /home/runner/work/MISP/MISP/app/Test/docker/docker-compose.tests.yml up -d
      - name: Sleep
        uses: jakejarvis/wait-action@master
        with:
          time: '30s'
      - name: Add Docker MISP CA to trusted certificates
        run: |
          sudo cp /home/runner/work/MISP/MISP/docker-misp/ssl/cert.pem /etc/ssl/certs/docker-misp.pem
          sudo chmod 644 /etc/ssl/certs/docker-misp.pem
          sudo update-ca-certificates
      - name: Check running containers
        run: docker ps
      - name: Run API test suite
        run: |
          sudo chown -R $USER:$USER /home/runner/work/MISP/MISP/app/Test/_output/
          cd app/
          # make test
          Vendor/bin/codecept build
          Vendor/bin/codecept run Test/Api/Attributes/IndexAttributesCest.php
      - name: Debug logs
        run: |
          tail -n 200 /home/runner/work/MISP/MISP/app/tmp/logs/debug.log
          tail -n 200 /home/runner/work/MISP/MISP/app/tmp/logs/error.log
