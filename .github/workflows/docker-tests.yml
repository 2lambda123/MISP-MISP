name: Docker API Tests

on:
  push:
    branches: [add-codeception-api-tests]

  workflow_dispatch:

jobs:
  test-api-dockerized:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
    steps:
      #- name: Install dependencies
      #  run: |
      #    sudo apt-get -y update
      #    sudo apt-get -y install curl openssl
      #    openssl version
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: 'add-codeception-api-tests'
          submodules: 'recursive'
      - name: Install PHP dependencies
        uses: php-actions/composer@v6
        with:
          php_version: 7.2
          version: 2
          php_extensions: pcntl curl
          args: --working-dir=app/
      - name: Checkout coolacid/docker-misp
        uses: actions/checkout@v2
        with:
          repository: coolacid/docker-misp
          path: docker-misp
      - name: Start MISP docker containers
        run: docker-compose -f /home/runner/work/MISP/MISP/docker-misp/docker-compose.yml -f /home/runner/work/MISP/MISP/app/Test/docker/docker-compose.tests.yml up -d
      - name: Wait 30s for containers to spin up
        uses: jakejarvis/wait-action@master
        with:
          time: '30s'
      #- name: Add Docker MISP CA to trusted certificates
      #  continue-on-error: true
      #  run: |
      #    sudo cp /home/runner/work/MISP/MISP/docker-misp/ssl/cert.pem /usr/local/share/ca-certificates/docker-misp.crt
      #    sudo chmod 644 /usr/local/share/ca-certificates/docker-misp.crt
      #    sudo update-ca-certificates
      #    openssl s_client -connect localhost:443 -CApath /etc/ssl/certs
      - name: Check running containers
        run: docker ps
      - name: Turn MISP live
        run: |
          docker-compose -f /home/runner/work/MISP/MISP/docker-misp/docker-compose.yml exec -T --user www-data misp bash -c "/var/www/MISP/app/Console/cake Live 1"
      - name: Run API test suite
        run: |
          sudo chown -R $USER:$USER /home/runner/work/MISP/MISP/app/Test/_output/
          cd app/
          make test
      #- name: Debug logs
      #  run: |
      #    docker ps
      #    docker-compose -f /home/runner/work/MISP/MISP/docker-misp/docker-compose.yml logs misp
      #    docker-compose -f /home/runner/work/MISP/MISP/docker-misp/docker-compose.yml exec -T --user www-data misp bash -c "tail -n 100 /var/www/MISP/app/tmp/logs/error.log"
